I"ª=<h1 id="descripci√≥n-general-de-classifiers">Descripci√≥n General de Classifiers</h1>

<!--

Google Earth Engine ofrece a los usuarios la oportunidad de realizar muchos an√°lisis avanzados, como la spectral un-mixing, object-based methods, eigen analysis and linear modeling.  Tambi√©n se dispone de t√©cnicas de machine learning para la clasificaci√≥n supervisada y no supervisada. En este ejemplo, utilizaremos la clasificaci√≥n supervisada para la clasificaci√≥n de la cobertura terrestre.

El prop√≥sito es obtener un mapa clasificado de la cobertura terrestre en un √°rea de inter√©s. Examinaremos las im√°genes Landsat e identificaremos manualmente un conjunto de puntos de entrenamiento para tres clases (agua, bosque, urbano). Luego usaremos esos puntos para entrenar un clasificador. El algor√≠tmo se utilizar√° para clasificar el resto de la imagen Landsat en esas tres categor√≠as. Finalmente, podremos evaluar la precisi√≥n de nuestra clasificaci√≥n usando `classifier.confusionMatrix()`.


*Adaptado de [Earth Engine 201 Intermediate workshop](https://developers.google.com/earth-engine/classification)*

# Ejercicio: Clasificar la cobertura del suelo usando las im√°genes Landsat

### Delimitar un √°rea de inter√©s (ROI) a partir de coordenadas

Primero, necesitamos definir una regi√≥n de inter√©s (ROI). En lugar de utilizar un Asset importado, utilizaremos una √∫nica coordenada que definiremos manualmente. Estamos interesado en hacer una clasificaci√≥n alrededor de Houston, as√≠ que usar√© el centro de la ciudad como mi lat/lon.


<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Definir una regi√≥n de inter√©s como un punto.  Cambiar las coordenadas</span>
<span class="c1">// para seleccionar ROI en su √°rea de inter√©s.</span>
<span class="c1">// Puede usar la herramienta de inspecci√≥n para encontrar sus coordenadas</span>
<span class="kd">var</span> <span class="nx">roi</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">74.58</span><span class="p">,</span><span class="o">-</span><span class="mf">8.39</span><span class="p">);</span></code></pre></figure>


### Cargar una `ImageCollection` ya filtrarla para obtener una sola im√°gen

Ahora cargaremos las im√°genes de Landsat y filtraremos el √°rea y las fechas de inter√©s.  Podemos usar `sort` para filtrar la `ImageCollection` por el % de cobertura de nubes, una propiedad incluida en la Landsat Top of Atmosphere (TOA) collection. Luego seleccionamos la `Image` que presente menor nubosidad`first` de la `ImageCollection` ordenada.


<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Cargue la image collection: Landsat 8 scaled radiance.</span>
<span class="kd">var</span> <span class="nx">landsatCollection</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">ImageCollection</span><span class="p">(</span><span class="dl">'</span><span class="s1">LANDSAT/LC08/C01/T1</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">filterDate</span><span class="p">(</span><span class="dl">'</span><span class="s1">2017-01-01</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">2017-12-31</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Haz un compuesto sin nubes.</span>
<span class="kd">var</span> <span class="nx">composite</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">Algorithms</span><span class="p">.</span><span class="nx">Landsat</span><span class="p">.</span><span class="nx">simpleComposite</span><span class="p">({</span>
  <span class="na">collection</span><span class="p">:</span> <span class="nx">landsatCollection</span><span class="p">,</span>
  <span class="na">asFloat</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">});</span>

<span class="c1">// Visualizar el compuesto</span>
<span class="nb">Map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">composite</span><span class="p">,</span> <span class="p">{</span><span class="na">bands</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">B4</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">B3</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">B2</span><span class="dl">'</span><span class="p">],</span> <span class="na">max</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="na">gamma</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="dl">'</span><span class="s1">L8 Image</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span></code></pre></figure>


### Seleccionar la data de entrenamiento

El segundo paso es recoger datos de entrenamiento.  Usando las im√°genes como gu√≠a, pasa por encima de la casilla 'Geometry Imports' junto a la herramienta de dibujo de geometr√≠as y haz clic en '+ new layer'.  Cada nueva capa representa una clase dentro de los datos de entrenamiento. Dejemos que la primera capa nueva represente 'urban'. 

Localice puntos en la nueva capa en √°reas urbanas o edificadas (edificios, carreteras, aparcamientos, etc.).  Cuando termine de recolectar los puntos, haga clic en 'Exit' y configure la importaci√≥n (parte superior del script) de la siguiente manera.  Nombrar la capa 'urban' y hacer clic en el icono para configurarla.  'Import as' `FeatureCollection`.  'Add property' landcover y establecer su valor a 0. (Las clases subsiguientes ser√°n 1 para el agua, 2 para el bosque, etc.) cuando termine, haga clic en 'OK' como se muestra:

<br>
<img src="../fig/03_geomConfig.png" border = "10" width="50%" height="50%">
<br><br>

Cuando termines de hacer una `FeatureCollection` para cada clase (3 en total), puedes fusionarlas en una `FeatureCollection` usando `featureCollection.merge()`. Esto lo convertir√° en una colecci√≥n en la que la propiedad **landcover** tiene un valor que es la clase (0, 1, 2).


<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Fusionar los puntos</span>
<span class="kd">var</span> <span class="nx">newfc</span> <span class="o">=</span> <span class="nx">water</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">urban</span><span class="p">).</span><span class="nx">merge</span><span class="p">(</span><span class="nx">forest</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">newfc</span><span class="p">,</span> <span class="dl">'</span><span class="s1">newfc</span><span class="dl">'</span><span class="p">)</span></code></pre></figure>


La declaraci√≥n impresa mostrar√° la nueva colecci√≥n en la **Console**.

### Realizar el muestreo de la im√°gen usando puntos de entrenamiento

Ahora que has creado los puntos y sus etiquetas, necesitas probar las im√°genes Landsat 8 usando `image.sampleRegions()`. Este comando extraer√° la reflectancia en las bandas designadas para cada uno de los puntos que has creado. Un diagrama conceptual de esto se muestra en la imagen de abajo. Usaremos la reflectancia de las bandas √≥pticas, NIR y SWIR (B2 - B7).

<br>
<img src="../fig/03_classificationsample.png" border = "10" width="30%" height="30%">
<br><br>


<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Selecciona las bandas para el entrenamiento</span>
<span class="kd">var</span> <span class="nx">bands</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">B2</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">B3</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">B4</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">B5</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">B6</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">B7</span><span class="dl">'</span><span class="p">];</span>

<span class="c1">// Muestre las im√°genes de entrada para obtener una FeatureCollection de datos de entrenamiento.</span>
<span class="kd">var</span> <span class="nx">training</span> <span class="o">=</span> <span class="nx">composite</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">bands</span><span class="p">).</span><span class="nx">sampleRegions</span><span class="p">({</span>
  <span class="na">collection</span><span class="p">:</span> <span class="nx">newfc</span><span class="p">,</span>
  <span class="na">properties</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">landcover</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">scale</span><span class="p">:</span> <span class="mi">30</span>
<span class="p">});</span></code></pre></figure>


La `FeatureCollection` llamada **training** tiene el valor de reflectancia de cada banda almacenado para cada punto de entrenamiento junto con su etiqueta de clase.

### Entrenar el clasificador
Ahora inicializaremos un `classifier` usando `ee.Classifier.randomForest()` y `train` en los datos de entrenamiento especificando las caracter√≠sticas a usar (entrenamiento), las categor√≠as de la cobertura del suelo como `classProperty` en la que queremos categorizar las im√°genes, y la reflectancia en B2 - B7 de las im√°genes Landsat como las `inputProperties`.


<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Haz un clasificador de Random Forest y entr√©nalo.</span>
<span class="kd">var</span> <span class="nx">classifier</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">Classifier</span><span class="p">.</span><span class="nx">randomForest</span><span class="p">().</span><span class="nx">train</span><span class="p">({</span>
  <span class="na">features</span><span class="p">:</span> <span class="nx">training</span><span class="p">,</span>
  <span class="na">classProperty</span><span class="p">:</span> <span class="dl">'</span><span class="s1">landcover</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">inputProperties</span><span class="p">:</span> <span class="nx">bands</span>
<span class="p">});</span></code></pre></figure>


Otros clasificadores, incluyendo Support Vector Machines (SVM) y Classification and Regression Trees (CART) est√°n disponibles en GEE. Ver el [Supervised Classification User Guide](https://developers.google.com/earth-engine/classification) for more examples.


### Clasificar la im√°gen y plotear los resultados

Usa el nuevo `classifier` para clasificar el resto de las im√°genes.


<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Clasificar las im√°genes de entrada.</span>
<span class="kd">var</span> <span class="nx">classified</span> <span class="o">=</span> <span class="nx">composite</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">bands</span><span class="p">).</span><span class="nx">classify</span><span class="p">(</span><span class="nx">classifier</span><span class="p">);</span>

<span class="c1">// Definir una paleta para la clasificaci√≥n del uso de la tierra.</span>
<span class="kd">var</span> <span class="nx">palette</span> <span class="o">=</span> <span class="p">[</span>
  <span class="dl">'</span><span class="s1">D3D3D3</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// urban (0)  // grey</span>
  <span class="dl">'</span><span class="s1">0000FF</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// water (1)  // blue</span>
  <span class="dl">'</span><span class="s1">008000</span><span class="dl">'</span> <span class="c1">//  forest (2) // green</span>
<span class="p">];</span>

<span class="c1">// Muestra el resultado de la clasificaci√≥n y la imagen de entrada.</span>
<span class="nb">Map</span><span class="p">.</span><span class="nx">setCenter</span><span class="p">(</span><span class="o">-</span><span class="mf">96.0171</span><span class="p">,</span> <span class="mf">29.6803</span><span class="p">);</span>
<span class="nb">Map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">classified</span><span class="p">,</span> <span class="p">{</span><span class="na">min</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">max</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">palette</span><span class="p">:</span> <span class="nx">palette</span><span class="p">},</span> <span class="dl">'</span><span class="s1">Land Use Classification</span><span class="dl">'</span><span class="p">);</span></code></pre></figure>


Deber√≠as obtener una imagen que se parezca a la de abajo. ¬°Despl√°cese por el mapa y use el inspector para ver c√≥mo lo hizo!

<br>
<img src="../fig/03_classifiedN.png" border = "10" width="100%" height="100%">
<br><br>


### Evaluar la precisi√≥n

Podemos evaluar la precisi√≥n del `classifier` entrenado usando una `confusionMatrix`.


<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Estima la matriz de confusi√≥n que represente la precisi√≥n de la clasificaci√≥n.</span>
<span class="nx">print</span><span class="p">(</span><span class="dl">'</span><span class="s1">RF error matrix: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">classifier</span><span class="p">.</span><span class="nx">confusionMatrix</span><span class="p">());</span>
<span class="nx">print</span><span class="p">(</span><span class="dl">'</span><span class="s1">RF accuracy: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">classifier</span><span class="p">.</span><span class="nx">confusionMatrix</span><span class="p">().</span><span class="nx">accuracy</span><span class="p">());</span></code></pre></figure>


Advertencia: En este ejemplo en particular, s√≥lo estamos observando el `trainAccuracy`, que b√°sicamente describe lo bien que el `classifier` fue capaz de etiquetar correctamente los datos de entrenamiento sustituidos, es decir, los datos que el `classifier` ya hab√≠a reconocido. Para obtener una verdadera precisi√≥n de validaci√≥n, necesitamos mostrarle al clasificador los nuevos datos de 'testing'. El script del repositorio tiene una secci√≥n extra al final que mantiene los datos para las pruebas, aplica el clasificador a los datos de las pruebas y eval√∫a la `errorMatrix` para estos datos de validaci√≥n. El √∫ltimo ejemplo en el [Supervised Classification User Guide](https://developers.google.com/earth-engine/classification) tambi√©n da un script ejemplo para este proceso.

Enlace al c√≥digo completo que usamos en esta sesi√≥n:
[https://code.earthengine.google.com/86b72b6fb9040967b66f09b17ce26c84](https://code.earthengine.google.com/86b72b6fb9040967b66f09b17ce26c84)
-->
:ET